import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart';
import 'dart:async';
import 'dart:math' as math;
import '../components/alpha_enmu.dart';
import '../model/bangla_alphabet_model.dart';

class AlphabetController {
  AlphabetTheme currentTheme = AlphabetTheme.storybook;
  LetterModel? selectedLetter;
  bool isReading = false;
  late FlutterTts flutterTts;
  List<ParticleEffect> particles = [];
  late AnimationController floatingController;
  late AnimationController particleController;
  late AnimationController readingController;
  late AnimationController themeTransitionController;
  late AnimationController ambientController;
  Timer? _particleTimer;

  final List<LetterModel> letters = [
    LetterModel(letter: 'ржХ', pronunciation: 'ko', phonetic: '/k╔Ф/', word: 'ржХрж╛ржХ', description: 'ржПржХржЯрж┐ ржкрж╛ржЦрж┐', icon: 'ЁЯРж', primaryColor: Color(0xFFF1C40F), secondaryColor: Color(0xFFF39C12)),
    LetterModel(letter: 'ржЦ', pronunciation: 'kho', phonetic: '/k╩░╔Ф/', word: 'ржЦрж░ржЧрзЛрж╢', description: 'ржПржХржЯрж┐ ржкрзНрж░рж╛ржгрзА', icon: 'ЁЯРЗ', primaryColor: Color(0xFF9B59B6), secondaryColor: Color(0xFF8E44AD)),
    LetterModel(letter: 'ржЧ', pronunciation: 'go', phonetic: '/g╔Ф/', word: 'ржЧрж░рзБ', description: 'ржЧрзГрж╣ржкрж╛рж▓рж┐ржд ржкрзНрж░рж╛ржгрзА', icon: 'ЁЯРД', primaryColor: Color(0xFF2C3E50), secondaryColor: Color(0xFF34495E)),
    LetterModel(letter: 'ржШ', pronunciation: 'gho', phonetic: '/╔б╩▒╔Ф/', word: 'ржШрзЛржбрж╝рж╛', description: 'ржПржХржЯрж┐ ржкрзНрж░рж╛ржгрзА', icon: 'ЁЯРО', primaryColor: Color(0xFF3498DB), secondaryColor: Color(0xFF2980B9)),
    LetterModel(letter: 'ржЩ', pronunciation: 'ung', phonetic: '/┼Л╔Ф/', word: 'ржЩрж┐ржи', description: 'ржкрзНрж░рждрзАржХрзА ржзрзНржмржирж┐', icon: 'ЁЯФФ', primaryColor: Color(0xFF1ABC9C), secondaryColor: Color(0xFF16A085)),

    LetterModel(letter: 'ржЪ', pronunciation: 'cho', phonetic: '/t╩Г╔Ф/', word: 'ржЪрж╢ржорж╛', description: 'ржЪрзЛржЦрзЗрж░ ржЬржирзНржп', icon: 'ЁЯСУ', primaryColor: Color(0xFFE74C3C), secondaryColor: Color(0xFFC0392B)),
    LetterModel(letter: 'ржЫ', pronunciation: 'chho', phonetic: '/t╩Г╩░╔Ф/', word: 'ржЫрж╛рждрж╛', description: 'ржмрзГрж╖рзНржЯрж┐ ржерзЗржХрзЗ ржмрж╛ржБржЪрзЗ', icon: 'тШВя╕П', primaryColor: Color(0xFFFF6B9D), secondaryColor: Color(0xFFFFA8E2)),
    LetterModel(letter: 'ржЬ', pronunciation: 'jo', phonetic: '/d╩Т╔Ф/', word: 'ржЬрж╛рж╣рж╛ржЬ', description: 'ржирзМржХрж╛', icon: 'ЁЯЪв', primaryColor: Color(0xFFFFD93D), secondaryColor: Color(0xFFFF6B6B)),
    LetterModel(letter: 'ржЭ', pronunciation: 'jho', phonetic: '/d╩Т╩▒╔Ф/', word: 'ржЭрзБржбрж╝рж┐', description: 'ржПржХржЯрж┐ ржЭрзБржбрж╝рж┐', icon: 'ЁЯз║', primaryColor: Color(0xFF74B9FF), secondaryColor: Color(0xFF0984E3)),
    LetterModel(letter: 'ржЮ', pronunciation: 'nyo', phonetic: '/╔▓╔Ф/', word: 'ржЮрзНржпрж╛ржи', description: 'рж╢ржмрзНржж ржЙржЪрзНржЪрж╛рж░ржг', icon: 'ЁЯФК', primaryColor: Color(0xFF6C5CE7), secondaryColor: Color(0xFFA29BFE)),

    LetterModel(letter: 'ржХ', pronunciation: 'ko', phonetic: '/k╔Ф/', word: 'ржХрж╛ржХ', description: 'ржПржХржЯрж┐ ржкрж╛ржЦрж┐', icon: 'ЁЯРж', primaryColor: Color(0xFFF1C40F), secondaryColor: Color(0xFFF39C12)),
    LetterModel(letter: 'ржЦ', pronunciation: 'kho', phonetic: '/k╩░╔Ф/', word: 'ржЦрж░ржЧрзЛрж╢', description: 'ржПржХржЯрж┐ ржкрзНрж░рж╛ржгрзА', icon: 'ЁЯРЗ', primaryColor: Color(0xFF9B59B6), secondaryColor: Color(0xFF8E44AD)),
    LetterModel(letter: 'ржЧ', pronunciation: 'go', phonetic: '/g╔Ф/', word: 'ржЧрж░рзБ', description: 'ржЧрзГрж╣ржкрж╛рж▓рж┐ржд ржкрзНрж░рж╛ржгрзА', icon: 'ЁЯРД', primaryColor: Color(0xFF2C3E50), secondaryColor: Color(0xFF34495E)),
    LetterModel(letter: 'ржШ', pronunciation: 'gho', phonetic: '/╔б╩▒╔Ф/', word: 'ржШрзЛржбрж╝рж╛', description: 'ржПржХржЯрж┐ ржкрзНрж░рж╛ржгрзА', icon: 'ЁЯРО', primaryColor: Color(0xFF3498DB), secondaryColor: Color(0xFF2980B9)),
    LetterModel(letter: 'ржЩ', pronunciation: 'ung', phonetic: '/┼Л╔Ф/', word: 'ржЩрж┐ржи', description: 'ржкрзНрж░рждрзАржХрзА ржзрзНржмржирж┐', icon: 'ЁЯФФ', primaryColor: Color(0xFF1ABC9C), secondaryColor: Color(0xFF16A085)),

    LetterModel(letter: 'ржЪ', pronunciation: 'cho', phonetic: '/t╩Г╔Ф/', word: 'ржЪрж╢ржорж╛', description: 'ржЪрзЛржЦрзЗрж░ ржЬржирзНржп', icon: 'ЁЯСУ', primaryColor: Color(0xFFE74C3C), secondaryColor: Color(0xFFC0392B)),
    LetterModel(letter: 'ржЫ', pronunciation: 'chho', phonetic: '/t╩Г╩░╔Ф/', word: 'ржЫрж╛рждрж╛', description: 'ржмрзГрж╖рзНржЯрж┐ ржерзЗржХрзЗ рж░ржХрзНрж╖рж╛', icon: 'тШВя╕П', primaryColor: Color(0xFFFF6B9D), secondaryColor: Color(0xFFFFA8E2)),
    LetterModel(letter: 'ржЬ', pronunciation: 'jo', phonetic: '/d╩Т╔Ф/', word: 'ржЬрж╛рж╣рж╛ржЬ', description: 'рж╕ржорзБржжрзНрж░ ржпрж╛ржи', icon: 'ЁЯЪв', primaryColor: Color(0xFFFFD93D), secondaryColor: Color(0xFFFF6B6B)),
    LetterModel(letter: 'ржЭ', pronunciation: 'jho', phonetic: '/d╩Т╩▒╔Ф/', word: 'ржЭрзБржбрж╝рж┐', description: 'ржПржХржЯрж┐ ржЭрзБржбрж╝рж┐', icon: 'ЁЯз║', primaryColor: Color(0xFF74B9FF), secondaryColor: Color(0xFF0984E3)),
    LetterModel(letter: 'ржЮ', pronunciation: 'nyo', phonetic: '/╔▓╔Ф/', word: 'ржЮрзНржпрж╛ржи', description: 'рж╢ржмрзНржж ржЙржЪрзНржЪрж╛рж░ржг', icon: 'ЁЯФК', primaryColor: Color(0xFF6C5CE7), secondaryColor: Color(0xFFA29BFE)),

    LetterModel(letter: 'ржЯ', pronunciation: 'to', phonetic: '/╩И╔Ф/', word: 'ржЯржм', description: 'ржЧрж╛ржЫрзЗрж░ ржЯржм', icon: 'ЁЯк┤', primaryColor: Color(0xFFE17055), secondaryColor: Color(0xFFFD79A8)),
    LetterModel(letter: 'ржа', pronunciation: 'tho', phonetic: '/╩И╩░╔Ф/', word: 'ржарж╛ржХрзБрж░', description: 'рж╕ржорзНржорж╛ржирж┐ржд ржмрзНржпржХрзНрждрж┐', icon: 'ЁЯЩП', primaryColor: Color(0xFF00CEC9), secondaryColor: Color(0xFF55EFC4)),
    LetterModel(letter: 'ржб', pronunciation: 'do', phonetic: '/╔Ц╔Ф/', word: 'ржбрж╛ржХрзНрждрж╛рж░', description: 'ржЪрж┐ржХрж┐рзОрж╕ржХ', icon: 'ЁЯСитАНтЪХя╕П', primaryColor: Color(0xFFFF6B6B), secondaryColor: Color(0xFFFFE66D)),
    LetterModel(letter: 'ржв', pronunciation: 'dho', phonetic: '/╔Ц╩▒╔Ф/', word: 'ржврж╛ржХ', description: 'ржмрж╛ржжрзНржпржпржирзНрждрзНрж░', icon: 'ЁЯеБ', primaryColor: Color(0xFF4ECDC4), secondaryColor: Color(0xFF45B7D1)),
    LetterModel(letter: 'ржг', pronunciation: 'no', phonetic: '/╔│╔Ф/', word: 'ржгржм', description: 'ржмрж┐рж░рж▓ рж╢ржмрзНржж', icon: 'ЁЯФг', primaryColor: Color(0xFFFF9FF3), secondaryColor: Color(0xFFF368E0)),

    LetterModel(letter: 'ржд', pronunciation: 'to', phonetic: '/t╔Ф/', word: 'рждрж╛рж▓рж╛', description: 'рж▓ржХ', icon: 'ЁЯФТ', primaryColor: Color(0xFF5F27CD), secondaryColor: Color(0xFF00D2D3)),
    LetterModel(letter: 'рже', pronunciation: 'tho', phonetic: '/t╩░╔Ф/', word: 'ржерж╛рж▓рж╛', description: 'ржЦрж╛ржУржпрж╝рж╛рж░ ржкрж╛рждрзНрж░', icon: 'ЁЯН╜я╕П', primaryColor: Color(0xFFE55039), secondaryColor: Color(0xFFFA983A)),
    LetterModel(letter: 'ржж', pronunciation: 'do', phonetic: '/d╔Ф/', word: 'ржжрзБржз', description: 'ржкрж╛ржирзАржпрж╝', icon: 'ЁЯеЫ', primaryColor: Color(0xFF3867D6), secondaryColor: Color(0xFF8854D0)),
    LetterModel(letter: 'ржз', pronunciation: 'dho', phonetic: '/d╩▒╔Ф/', word: 'ржзрж╛ржи', description: 'рж╢рж╕рзНржп', icon: 'ЁЯМ╛', primaryColor: Color(0xFF2ECC71), secondaryColor: Color(0xFF27AE60)),
    LetterModel(letter: 'ржи', pronunciation: 'no', phonetic: '/n╔Ф/', word: 'ржиржжрзА', description: 'ржЬрж▓ржзрж╛рж░рж╛', icon: 'ЁЯМК', primaryColor: Color(0xFF95A5A6), secondaryColor: Color(0xFFBDC3C7)),

    LetterModel(letter: 'ржк', pronunciation: 'po', phonetic: '/p╔Ф/', word: 'ржкрж╛ржЦрж┐', description: 'ржЙржбрж╝ржирзНржд ржкрзНрж░рж╛ржгрзА', icon: 'ЁЯХКя╕П', primaryColor: Color(0xFFF1C40F), secondaryColor: Color(0xFFF39C12)),
    LetterModel(letter: 'ржл', pronunciation: 'pho', phonetic: '/p╩░╔Ф/', word: 'ржлрзБрж▓', description: 'ржЧрж╛ржЫрзЗрж░ рж╕рзМржирзНржжрж░рзНржп', icon: 'ЁЯМ╕', primaryColor: Color(0xFF9B59B6), secondaryColor: Color(0xFF8E44AD)),
    LetterModel(letter: 'ржм', pronunciation: 'bo', phonetic: '/b╔Ф/', word: 'ржмржЗ', description: 'рж╢рж┐ржХрзНрж╖рж╛рж░ ржорж╛ржзрзНржпржо', icon: 'ЁЯУЦ', primaryColor: Color(0xFF2C3E50), secondaryColor: Color(0xFF34495E)),
    LetterModel(letter: 'ржн', pronunciation: 'bho', phonetic: '/b╩▒╔Ф/', word: 'ржнрж╛ржд', description: 'ржЦрж╛ржмрж╛рж░', icon: 'ЁЯНЪ', primaryColor: Color(0xFF3498DB), secondaryColor: Color(0xFF2980B9)),
    LetterModel(letter: 'ржо', pronunciation: 'mo', phonetic: '/m╔Ф/', word: 'ржорж╛ржЫ', description: 'ржЬрж▓ржЬ ржкрзНрж░рж╛ржгрзА', icon: 'ЁЯРЯ', primaryColor: Color(0xFF1ABC9C), secondaryColor: Color(0xFF16A085)),

    LetterModel(letter: 'ржп', pronunciation: 'zo', phonetic: '/z╔Ф/', word: 'ржпрж╛ржиржмрж╛рж╣ржи', description: 'ржпрж╛рждрж╛ржпрж╝рж╛рждрзЗрж░ ржорж╛ржзрзНржпржо', icon: 'ЁЯЪМ', primaryColor: Color(0xFFE74C3C), secondaryColor: Color(0xFFC0392B)),
    LetterModel(letter: 'рж░', pronunciation: 'ro', phonetic: '/r╔Ф/', word: 'рж░рзЛржж', description: 'рж╕рзВрж░рзНржпрзЗрж░ ржЖрж▓рзЛ', icon: 'тШАя╕П', primaryColor: Color(0xFFFF6B9D), secondaryColor: Color(0xFFFFA8E2)),
    LetterModel(letter: 'рж▓', pronunciation: 'lo', phonetic: '/l╔Ф/', word: 'рж▓рж╛рж▓', description: 'ржПржХржЯрж┐ рж░ржВ', icon: 'ЁЯЯе', primaryColor: Color(0xFFFFD93D), secondaryColor: Color(0xFFFF6B6B)),
    LetterModel(letter: 'рж╢', pronunciation: 'sho', phonetic: '/╩Г╔Ф/', word: 'рж╢рж┐рж╢рзБ', description: 'ржЫрзЛржЯ ржмрж╛ржЪрзНржЪрж╛', icon: 'ЁЯзТ', primaryColor: Color(0xFF74B9FF), secondaryColor: Color(0xFF0984E3)),
    LetterModel(letter: 'рж╖', pronunciation: 'ssho', phonetic: '/╩В╔Ф/', word: 'рж╖рж╛ржБржбрж╝', description: 'ржкрзНрж░рж╛ржгрзА', icon: 'ЁЯРВ', primaryColor: Color(0xFF6C5CE7), secondaryColor: Color(0xFFA29BFE)),

    LetterModel(letter: 'рж╕', pronunciation: 'so', phonetic: '/s╔Ф/', word: 'рж╕рж╛ржк', description: 'рж╕рж░рзАрж╕рзГржк', icon: 'ЁЯРН', primaryColor: Color(0xFFE17055), secondaryColor: Color(0xFFFD79A8)),
    LetterModel(letter: 'рж╣', pronunciation: 'ho', phonetic: '/╔ж╔Ф/', word: 'рж╣рж╛рждрж┐', description: 'ржмржбрж╝ ржкрзНрж░рж╛ржгрзА', icon: 'ЁЯРШ', primaryColor: Color(0xFF00CEC9), secondaryColor: Color(0xFF55EFC4)),
    LetterModel(letter: 'ржбрж╝', pronunciation: 'ro', phonetic: '/╔╜╔Ф/', word: 'ржбрж╝рж╛рж▓', description: 'ржмрж┐рж░рж▓ рж╢ржмрзНржж', icon: 'ЁЯФб', primaryColor: Color(0xFFFF6B6B), secondaryColor: Color(0xFFFFE66D)),
    LetterModel(letter: 'ржврж╝', pronunciation: 'rho', phonetic: '/╔╜╩▒╔Ф/', word: 'ржврж╝', description: 'ржЙржЪрзНржЪрж╛рж░ржг ржмрж┐рж╢рзЗрж╖', icon: 'ЁЯФа', primaryColor: Color(0xFF4ECDC4), secondaryColor: Color(0xFF45B7D1)),
    LetterModel(letter: 'ржпрж╝', pronunciation: 'y', phonetic: '/j╔Ф/', word: 'ржмрж╛ржВрж▓рж╛ржпрж╝', description: 'рж╢ржмрзНржжрзЗрж░ ржЕржВрж╢', icon: 'ЁЯУЭ', primaryColor: Color(0xFFFF9FF3), secondaryColor: Color(0xFFF368E0)),

    LetterModel(letter: 'ржХрзНрж╖', pronunciation: 'kkho', phonetic: '/k╩░j╔Ф/', word: 'ржХрзНрж╖рзЗржд', description: 'ржзрж╛ржирзЗрж░ ржХрзНрж╖рзЗржд', icon: 'ЁЯМ▒', primaryColor: Color(0xFF5F27CD), secondaryColor: Color(0xFF00D2D3)),
    LetterModel(letter: 'рждрзНрж░', pronunciation: 'tro', phonetic: '/tr╔Ф/', word: 'рждрзНрж░рж┐ржнрзБржЬ', description: 'ржЬрзНржпрж╛ржорж┐рждрж┐ ржЖржХрж╛рж░', icon: 'ЁЯФ║', primaryColor: Color(0xFFE55039), secondaryColor: Color(0xFFFA983A)),
    LetterModel(letter: 'ржЬрзНржЮ', pronunciation: 'ggno', phonetic: '/╔бd╩Т╔Ф/', word: 'ржЬрзНржЮ', description: 'ржЬрзНржЮрж╛ржи', icon: 'ЁЯУЪ', primaryColor: Color(0xFF3867D6), secondaryColor: Color(0xFF8854D0)),
  ];

  final TickerProvider vsync;
  final Function(LetterModel, Offset) onLetterTap;
  final Function(AlphabetTheme) onSwitchTheme;
  final VoidCallback onCloseReading;

  AlphabetController({
    required this.vsync,
    required this.onLetterTap,
    required this.onSwitchTheme,
    required this.onCloseReading,
  });

  void init() {
    _initializeTts();
    _initializeAnimations();
    _startParticleSystem();
  }

  void _initializeTts() {
    flutterTts = FlutterTts();
    flutterTts.setLanguage("bn-US");
    flutterTts.setSpeechRate(0.7);
    flutterTts.setVolume(0.9);
    flutterTts.setPitch(1.2);
  }

  void _initializeAnimations() {
    floatingController = AnimationController(
      duration: const Duration(seconds: 3),
      vsync: vsync,
    )..repeat();

    particleController = AnimationController(
      duration: const Duration(milliseconds: 16),
      vsync: vsync,
    )..repeat();

    readingController = AnimationController(
      duration: const Duration(milliseconds: 800),
      vsync: vsync,
    );

    themeTransitionController = AnimationController(
      duration: const Duration(milliseconds: 600),
      vsync: vsync,
    );

    ambientController = AnimationController(
      duration: const Duration(seconds: 8),
      vsync: vsync,
    )..repeat();

    particleController.addListener(_updateParticles);
  }

  void _startParticleSystem() {
    _particleTimer = Timer.periodic(const Duration(milliseconds: 100), (timer) {
      if (particles.length < 20 && !isReading) {
        _createAmbientParticle();
      }
    });
  }

  void _updateParticles() {
    for (int i = particles.length - 1; i >= 0; i--) {
      particles[i].x += particles[i].vx;
      particles[i].y += particles[i].vy;
      particles[i].life--;
      particles[i].vy += 0.1; // Gravity

      if (particles[i].life <= 0) {
        particles.removeAt(i);
      }
    }
  }

  void _createAmbientParticle() {
    // This requires context for MediaQuery, so it should be passed or handled differently
    // For simplicity, we'll assume context is available or adjust in the calling widget
  }

  void createLetterParticles(Offset position) {
    final random = math.Random();

    for (int i = 0; i < 25; i++) {
      particles.add(ParticleEffect(
        x: position.dx,
        y: position.dy,
        vx: (random.nextDouble() - 0.5) * 12,
        vy: (random.nextDouble() - 0.5) * 12,
        size: random.nextDouble() * 8 + 4,
        color: _getThemeAccentColor(),
        maxLife: 120.0 + random.nextDouble() * 60,
        emoji: _getThemeParticleEmoji(),
      ));
    }
  }

  void createThemeChangeParticles(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final random = math.Random();

    for (int i = 0; i < 40; i++) {
      particles.add(ParticleEffect(
        x: size.width / 2,
        y: size.height / 2,
        vx: (random.nextDouble() - 0.5) * 16,
        vy: (random.nextDouble() - 0.5) * 16,
        size: random.nextDouble() * 10 + 6,
        color: _getThemeAccentColor(),
        maxLife: 150.0 + random.nextDouble() * 100,
        emoji: _getThemeParticleEmoji(),
      ));
    }
  }

  Color _getThemeAccentColor() {
    switch (currentTheme) {
      case AlphabetTheme.storybook:
        return const Color(0xFFFFD700);
      case AlphabetTheme.holographic:
        return const Color(0xFF00FFFF);
      case AlphabetTheme.enchanted:
        return const Color(0xFF90EE90);
      case AlphabetTheme.ocean:
        return const Color(0xFF87CEEB);
    }
  }

  String _getThemeParticleEmoji() {
    switch (currentTheme) {
      case AlphabetTheme.storybook:
        return ['тЬи', 'тнР', 'ЁЯМЯ', 'ЁЯТл'][math.Random().nextInt(4)];
      case AlphabetTheme.holographic:
        return ['тЪб', 'ЁЯТО', 'ЁЯФ╖', 'тЬж'][math.Random().nextInt(4)];
      case AlphabetTheme.enchanted:
        return ['ЁЯМ┐', 'ЁЯжЛ', 'ЁЯМ║', 'ЁЯНГ'][math.Random().nextInt(4)];
      case AlphabetTheme.ocean:
        return ['ЁЯРа', 'ЁЯлз', 'ЁЯМК', 'ЁЯРЪ'][math.Random().nextInt(4)];
    }
  }

  void speakLetter(LetterModel letter) async {
    await flutterTts.speak(letter.pronunciation);

    Future.delayed(const Duration(seconds: 4), () {
      if (isReading) {
        onCloseReading();
      }
    });
  }

  void dispose() {
    floatingController.dispose();
    particleController.dispose();
    readingController.dispose();
    themeTransitionController.dispose();
    ambientController.dispose();
    _particleTimer?.cancel();
    flutterTts.stop();
  }
}